<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Metadaten f√ºr Social Media & Suchmaschinen (Wichtig f√ºr GitHub Pages) -->
    <meta name="description" content="Interaktive Visualisierung des Newton-Verfahrens. Erstellt f√ºr das Numerik-Tutorium (Blatt 11).">
    <meta name="author" content="Dein Mathe-Tutor">
    
    <title>Mathe-Tutor: Newton-Verfahren Visualizer</title>

    <!-- Favicon: Zeigt einen Doktorhut im Browser-Tab an -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

    <!-- 
       ABH√ÑNGIGKEITEN (CDNs)
       Das hier macht die Seite "standalone". Es ist keine lokale Installation n√∂tig.
    -->
    <!-- 1. Tailwind CSS f√ºr das Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Plotly.js f√ºr die interaktiven Graphen -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- 3. Math.js f√ºr das Berechnen von Ableitungen im Browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.3.0/math.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Monospace-Font f√ºr mathematische Formeln */
        .math-font { font-family: 'Courier New', Courier, monospace; }
        
        /* Sanfter √úbergang f√ºr Buttons */
        button { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                    <span>üéì</span> Dein Mathe-Tutor
                </h1>
                <p class="text-indigo-200 text-xs md:text-sm">Newton-Verfahren Visualizer (Blatt 11)</p>
            </div>
            <button onclick="loadExample('task2')" class="bg-indigo-500 hover:bg-indigo-400 hover:shadow-md px-3 py-1 rounded text-sm font-medium border border-indigo-400">
                Lade Aufgabe 2
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-6xl mx-auto w-full p-4 flex flex-col md:flex-row gap-6">
        
        <!-- Linke Spalte: Controls & Info -->
        <div class="w-full md:w-1/3 space-y-6">
            
            <!-- Input Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 space-y-4">
                <h2 class="text-lg font-semibold border-b pb-2 text-indigo-600 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Konfiguration
                </h2>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Funktion f(x)</label>
                    <input type="text" id="funcInput" value="x^2 - 2" 
                        class="math-font mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 p-2 border transition-colors hover:bg-white"
                        placeholder="z.B. x^2 - 2">
                    <p class="text-xs text-gray-500 mt-1">Syntax: <code>x^2</code>, <code>sin(x)</code>, <code>10*exp(-x^2)-x</code></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Startwert x‚ÇÄ</label>
                    <input type="number" id="startInput" value="2" step="0.1"
                        class="math-font mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 p-2 border transition-colors hover:bg-white">
                </div>

                <div class="flex gap-2 pt-2">
                    <button onclick="initNewton()" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-2 px-4 rounded-md shadow-sm font-medium active:transform active:scale-95">
                        Start / Reset
                    </button>
                    <button id="stepBtn" onclick="nextStep()" disabled class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md shadow-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed active:transform active:scale-95">
                        N√§chster Schritt
                    </button>
                </div>
            </div>

            <!-- Status & Results -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 space-y-4">
                <h2 class="text-lg font-semibold border-b pb-2 text-indigo-600 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Verlauf
                </h2>
                
                <!-- Didaktik-Box -->
                <div id="hintBox" class="bg-blue-50 border-l-4 border-blue-500 p-4 text-sm text-blue-700 hidden rounded-r-md shadow-sm">
                    <p class="font-bold mb-1">üí° Tutor-Hinweis:</p>
                    <span id="hintText">Starte das Verfahren, um Hinweise zu erhalten.</span>
                </div>

                <!-- Table -->
                <div class="overflow-hidden rounded-lg border border-gray-200">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-100 font-medium text-gray-600">
                            <tr>
                                <th class="px-3 py-2">n</th>
                                <th class="px-3 py-2">x_n</th>
                                <th class="px-3 py-2">f(x_n)</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody" class="divide-y divide-gray-200 math-font bg-white">
                            <!-- Rows added by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="text-xs text-gray-400 text-center italic mt-2">
                    Max. 20 Schritte werden berechnet.
                </div>
            </div>
        </div>

        <!-- Rechte Spalte: Graph & Theorie -->
        <div class="w-full md:w-2/3 flex flex-col gap-6">
            
            <!-- Graph Panel -->
            <div class="bg-white p-1 rounded-xl shadow-md flex flex-col border border-gray-100 overflow-hidden relative min-h-[500px] md:min-h-[600px]">
                <div id="plotDiv" class="w-full flex-grow"></div>
                <!-- Overlay Info -->
                <div class="absolute bottom-2 right-2 bg-white/80 backdrop-blur-sm px-2 py-1 rounded text-xs text-gray-500 pointer-events-none border border-gray-200">
                    Interaktiv: Scrollen zum Zoomen
                </div>
            </div>

            <!-- NEU: Theorie-Spickzettel (√úberarbeitet) -->
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-5 shadow-sm text-amber-900">
                <h3 class="font-bold flex items-center gap-2 text-amber-700 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.394 2.08a1 1 0 00-1.788 0l-7 14a1 1 0 001.17 1.408l7-14zM12 9a1 1 0 11-2 0 1 1 0 012 0zm-1 2a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                    </svg>
                    Spickzettel: Die 4 Konvergenz-Regeln (Aufgabe 1)
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                    
                    <!-- Regel 1: Existenz -->
                    <div>
                        <p class="font-bold text-amber-800">1. Existenz</p>
                        <p>Es muss eine Nullstelle im Intervall geben (Vorzeichenwechsel).</p>
                        <code class="inline-block mt-1 px-1.5 py-0.5 bg-amber-100 rounded text-xs font-mono">f(a) ¬∑ f(b) < 0</code>
                    </div>

                    <!-- Regel 2: Monotonie -->
                    <div>
                        <p class="font-bold text-amber-800">2. Monotonie</p>
                        <p>Keine waagerechten Tangenten. Die Funktion muss streng monoton steigen oder fallen.</p>
                        <code class="inline-block mt-1 px-1.5 py-0.5 bg-amber-100 rounded text-xs font-mono">f'(x) ‚â† 0</code>
                    </div>

                    <!-- Regel 3: Kr√ºmmung -->
                    <div>
                        <p class="font-bold text-amber-800">3. Kr√ºmmung</p>
                        <p>Keine Wendepunkte im Intervall. Die Kr√ºmmung <i>f''(x)</i> darf das Vorzeichen nicht wechseln.</p>
                    </div>

                    <!-- Regel 4: Startwert -->
                    <div class="md:col-span-2 mt-2 pt-3 border-t border-amber-200">
                        <p class="font-bold text-amber-800 flex items-center gap-1">
                            <span>‚≠ê</span> 4. Die Goldene Regel f√ºr den Startwert x<sub>0</sub>
                        </p>
                        <p class="mb-1">W√§hle x<sub>0</sub> so, dass Funktionswert und Kr√ºmmung das <b>gleiche Vorzeichen</b> haben.</p>
                        <code class="block w-fit mb-1 px-2 py-1 bg-amber-100 rounded text-sm font-mono border border-amber-200">f(x<sub>0</sub>) ¬∑ f''(x<sub>0</sub>) > 0</code>
                        <p class="text-xs italic opacity-80 mt-1">
                            <b>Warum?</b> Wenn Funktion und Kr√ºmmung "zusammenarbeiten", liegt x<sub>0</sub> auf der steilen Seite der W√∂lbung. Das Verfahren konvergiert dann sicher und monoton zur Nullstelle, ohne wegzuspringen.
                        </p>
                    </div>

                </div>
            </div>

        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 text-center text-sm mt-8">
        <p class="mb-2">Erstellt f√ºr dein Mathe-Tutorium &hearts;</p>
        <p class="text-xs opacity-60">
            Powered by Tailwind CSS, Plotly.js & Math.js (keine Installation n√∂tig)
        </p>
    </footer>

    <!-- Logic Script -->
    <script>
        let currentStep = 0;
        let x_curr = 0;
        let funcCompiled = null;
        let derivCompiled = null;
        let history = [];
        let maxSteps = 20;

        // Initialize Plotly with hidden axes titles (we use annotations instead)
        const layout = {
            title: 'Funktionsgraph & Tangenten',
            font: { family: 'Segoe UI, sans-serif' },
            xaxis: { 
                zeroline: true, 
                gridcolor: '#f3f4f6', 
                zerolinecolor: '#333',
                zerolinewidth: 2,
                showgrid: true,
                showline: false, // Hide frame lines
            },
            yaxis: { 
                zeroline: true, 
                scaleanchor: "x", 
                scaleratio: 1, 
                gridcolor: '#f3f4f6',
                zerolinecolor: '#333',
                zerolinewidth: 2,
                showgrid: true,
                showline: false,
            },
            showlegend: true,
            hovermode: 'closest',
            shapes: [], 
            annotations: [], // Will be filled dynamically
            margin: {l: 30, r: 30, t: 50, b: 30}
        };
        
        const config = {responsive: true, displayModeBar: true, displaylogo: false};

        Plotly.newPlot('plotDiv', [{x:[], y:[], type:'scatter'}], layout, config);

        // Helper: Format number
        function fmt(n) { 
            if (Math.abs(n) < 1e-10) return "0";
            return math.round(n, 5); 
        }

        function loadExample(type) {
            if (type === 'task2') {
                // Aufgabe 2: f(x) = 10*exp(-x^2) - x
                document.getElementById('funcInput').value = "10 * exp(-x^2) - x";
                document.getElementById('startInput').value = "0.5"; // Schlechter Startwert zum Testen
                initNewton();
                document.getElementById('hintText').textContent = "Beispiel aus Aufgabe 2 geladen. Achte auf den Startwert!";
                document.getElementById('hintBox').classList.remove('hidden');
            }
        }

        function initNewton() {
            const funcStr = document.getElementById('funcInput').value;
            const startVal = parseFloat(document.getElementById('startInput').value);

            if (isNaN(startVal)) {
                alert("Bitte einen g√ºltigen Startwert eingeben.");
                return;
            }

            try {
                // 1. Compile Function and Derivative
                const node = math.parse(funcStr);
                funcCompiled = node.compile();
                const derivNode = math.derivative(node, 'x');
                derivCompiled = derivNode.compile();

                // 2. Reset State
                currentStep = 0;
                x_curr = startVal;
                history = [];
                document.getElementById('resultBody').innerHTML = '';
                document.getElementById('stepBtn').disabled = false;
                document.getElementById('hintBox').classList.add('hidden');

                // 3. Draw initial Function Graph
                drawFunction(startVal);
                
                // 4. Log step 0
                addTableRow(0, x_curr, funcCompiled.evaluate({x: x_curr}));
                
                // Update Hints
                updateHints(x_curr);

            } catch (err) {
                alert("Fehler beim Parsen der Funktion. Bitte Syntax pr√ºfen (z.B. 2*x statt 2x).\n\nFehler: " + err.message);
            }
        }

        function drawFunction(centerX) {
            // Create smart range based on start value
            const range = 5; 
            const steps = 300;
            const xs = [];
            const ys = [];
            const xMin = centerX - range;
            const xMax = centerX + range;
            
            // Collect points
            for (let i = 0; i <= steps; i++) {
                const x = xMin + (i/steps) * (xMax - xMin);
                try {
                    const y = funcCompiled.evaluate({x: x});
                    // Filter extreme values for better plotting
                    if (Math.abs(y) < 100) {
                        xs.push(x);
                        ys.push(y);
                    }
                } catch(e) {}
            }

            // Find effective Y range for label placement
            let yMaxPlot = 0;
            if (ys.length > 0) {
                yMaxPlot = Math.max(...ys.map(Math.abs));
                if (yMaxPlot === 0) yMaxPlot = 5; 
                // Add some padding
                yMaxPlot = yMaxPlot * 1.1; 
            } else {
                yMaxPlot = 5;
            }

            // Base Trace: The Function
            const trace1 = {
                x: xs, y: ys,
                mode: 'lines',
                name: 'f(x)',
                line: {color: '#4f46e5', width: 3}
            };

            // Custom Axis Labels via Annotations
            // This places 'x' at the right end of x-axis and 'f(x)' at top of y-axis
            const axisLabels = [
                {
                    x: xMax,
                    y: 0,
                    xref: 'x', yref: 'y',
                    text: '<b>x</b>',
                    showarrow: false,
                    xanchor: 'right',
                    yanchor: 'bottom',
                    font: {size: 16, family: 'serif', color: '#333'}
                },
                {
                    x: 0,
                    y: yMaxPlot, // Approximate top of visible area
                    xref: 'x', yref: 'y',
                    text: '<b>f(x)</b>',
                    showarrow: false,
                    xanchor: 'left',
                    yanchor: 'top',
                    font: {size: 16, family: 'serif', color: '#333'}
                }
            ];

            const currentLayout = {
                annotations: axisLabels,
                xaxis: { range: [xMin, xMax] }, // Explicit range ensures labels are at edges
                yaxis: { range: [-yMaxPlot, yMaxPlot] }
            };

            Plotly.react('plotDiv', [trace1], Object.assign({}, layout, currentLayout), config);
        }

        function nextStep() {
            if (currentStep >= maxSteps) return;

            const fx = funcCompiled.evaluate({x: x_curr});
            const dfx = derivCompiled.evaluate({x: x_curr});

            // Check Derivative Condition (Aufgabe 1, Punkt 2)
            if (Math.abs(dfx) < 1e-9) {
                showError("‚õî Waagerechte Tangente! f'(x) ‚âà 0. Das Verfahren bricht hier zusammen (Division durch Null).");
                document.getElementById('stepBtn').disabled = true;
                return;
            }

            const x_next = x_curr - (fx / dfx);
            currentStep++;

            // Visualisierung: Tangente
            const shapes = document.getElementById('plotDiv').layout.shapes || [];
            
            // 1. Line: Vertical drop to curve (visual helper)
            shapes.push({
                type: 'line',
                x0: x_curr, y0: 0,
                x1: x_curr, y1: fx,
                line: {color: 'gray', width: 1, dash: 'dot'}
            });

            // 2. Line: Tangent
            shapes.push({
                type: 'line',
                x0: x_curr, y0: fx,
                x1: x_next, y1: 0,
                line: {color: '#ef4444', width: 2} // Red tangent
            });

            // Update Plot with new shapes
            Plotly.relayout('plotDiv', {shapes: shapes});

            // Add marker for new x
            Plotly.addTraces('plotDiv', {
                x: [x_next],
                y: [0],
                mode: 'markers',
                marker: {color: '#10b981', size: 10, line: {color: 'white', width: 2}},
                name: `x_${currentStep}`
            });

            // Update Table & State
            addTableRow(currentStep, x_next, funcCompiled.evaluate({x: x_next}));
            x_curr = x_next;
            
            updateHints(x_curr);
        }

        function addTableRow(n, x, fx) {
            const tbody = document.getElementById('resultBody');
            const row = `<tr class="hover:bg-gray-50 transition-colors">
                <td class="px-3 py-2 text-gray-500">${n}</td>
                <td class="px-3 py-2 font-mono text-indigo-700">${fmt(x)}</td>
                <td class="px-3 py-2 font-mono text-gray-600">${fmt(fx)}</td>
            </tr>`;
            tbody.innerHTML += row;
            // Auto-scroll table to bottom
            const container = tbody.parentElement.parentElement;
            container.scrollTop = container.scrollHeight;
        }

        function updateHints(x) {
            const hintBox = document.getElementById('hintBox');
            const hintText = document.getElementById('hintText');
            const fx = funcCompiled.evaluate({x: x});
            const dfx = derivCompiled.evaluate({x: x});
            
            // Calculate second derivative roughly for the hint
            // f''(x) approx (f'(x+h) - f'(x)) / h
            const h = 1e-5;
            const dfx_h = derivCompiled.evaluate({x: x+h});
            const ddfx = (dfx_h - dfx) / h;

            hintBox.classList.remove('hidden');

            let msg = "";
            let cssClass = "";
            
            // Check: Konvergenz
            if (Math.abs(fx) < 1e-6) {
                cssClass = "bg-green-50 border-l-4 border-green-500 p-4 text-sm text-green-700 rounded-r-md shadow-sm";
                msg = "üéâ <b>Nullstelle gefunden!</b> Das Verfahren ist konvergiert.";
                document.getElementById('stepBtn').disabled = true;
            } else {
                cssClass = "bg-blue-50 border-l-4 border-blue-500 p-4 text-sm text-blue-700 rounded-r-md shadow-sm";
                msg = `<b>Schritt ${currentStep}:</b> `;
                
                // Check Aufgabe 1, Bedingung 4: f(x) * f''(x) > 0 ?
                if (fx * ddfx > 0) {
                    msg += "‚úÖ <br>Guter Bereich: f(x) und f''(x) haben das gleiche Vorzeichen. Wir n√§hern uns monoton.";
                } else {
                    msg += "‚ö†Ô∏è <br>Vorsicht: f(x) und f''(x) haben unterschiedliche Vorzeichen. Die Tangente k√∂nnte uns weit wegschie√üen (oder in einen Zyklus f√ºhren).";
                }
            }
            hintBox.className = cssClass;
            hintText.innerHTML = msg;
        }

        function showError(msg) {
            const hintBox = document.getElementById('hintBox');
            const hintText = document.getElementById('hintText');
            hintBox.className = "bg-red-50 border-l-4 border-red-500 p-4 text-sm text-red-700 rounded-r-md shadow-sm";
            hintBox.classList.remove('hidden');
            hintText.innerHTML = msg;
        }

        // Start initially
        initNewton();
    </script>
</body>
</html>

