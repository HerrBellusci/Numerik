<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixpunkte Labor Pro</title>
    
    <!-- Styling (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans', sans-serif; background-color: #f0f4f8; }
        .math-serif { font-family: 'Times New Roman', Times, serif; font-style: italic; }
        .code-font { font-family: 'Fira Code', monospace; }
        
        /* Custom Scrollbar for inputs */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #4f46e5; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px;
        }
        #loading { position: fixed; inset: 0; background: white; display: flex; justify-content: center; align-items: center; z-index: 100; font-weight: bold; color: #64748b; }
    </style>
</head>
<body>

    <div id="loading">Lade Mathe-Labor...</div>
    <div id="root"></div>

    <script type="text/babel">
        // Fallback Error Handling
        if (!window.React) { document.getElementById('loading').innerHTML = "Fehler beim Laden der Bibliotheken."; }

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- ICONS ---
        const IconPlay = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const IconPause = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const IconRefresh = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 21H3v-5"></path></svg>;
        const IconFunction = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 17l6-10M9 7l6 10M4 4h16"/></svg>;

        const M = ({ children }) => <span className="math-serif text-lg mx-0.5">{children}</span>;

        // --- SAFE MATH PARSER ---
        // Erzeugt eine JavaScript-Funktion aus einem String
        const createMathFunction = (formula) => {
            try {
                // Ersetze gängige Mathe-Ausdrücke für JS (z.B. sin -> Math.sin)
                let jsFormula = formula
                    .toLowerCase()
                    .replace(/\^/g, '**') // Power operator
                    .replace(/sin/g, 'Math.sin')
                    .replace(/cos/g, 'Math.cos')
                    .replace(/tan/g, 'Math.tan')
                    .replace(/sqrt/g, 'Math.sqrt')
                    .replace(/abs/g, 'Math.abs')
                    .replace(/exp/g, 'Math.exp')
                    .replace(/log/g, 'Math.log')
                    .replace(/pi/g, 'Math.PI')
                    .replace(/e/g, 'Math.E');

                // Erstelle Funktion: f(x) = ...
                return new Function('x', `return ${jsFormula};`);
            } catch (e) {
                return null;
            }
        };

        const App = () => {
            // State
            const [mode, setMode] = useState('linear'); // 'linear' or 'custom'
            const [formulaInput, setFormulaInput] = useState('cos(x)');
            const [slope, setSlope] = useState(0.5); // Für Linear-Modus
            const [startX, setStartX] = useState(0.5);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentStep, setCurrentStep] = useState(0);
            
            // Konfiguration
            const iterations = 50;
            const size = 320; 
            const rangeMin = -1;
            const rangeMax = 4;
            const range = rangeMax - rangeMin;

            // Timer
            useEffect(() => {
                let interval;
                if (isPlaying) {
                    interval = setInterval(() => {
                        setCurrentStep(prev => {
                            if (prev >= iterations) { setIsPlaying(false); return 0; }
                            return prev + 1;
                        });
                    }, 100);
                }
                return () => clearInterval(interval);
            }, [isPlaying]);

            // --- MATH CORE ---
            
            // Die eigentliche Funktion phi(x)
            const phi = useCallback((x) => {
                if (mode === 'linear') {
                    // Linear: m(x - 2) + 2 (Fixpunkt bei 2,2)
                    return slope * (x - 2) + 2;
                } else {
                    // Custom
                    const func = createMathFunction(formulaInput);
                    if (!func) return x; // Fallback
                    try { return func(x); } catch(e) { return x; }
                }
            }, [mode, slope, formulaInput]);

            // Numerische Ableitung berechnen: f'(x) ≈ (f(x+h) - f(x-h)) / 2h
            const calculateDerivative = (x) => {
                const h = 0.0001;
                const y1 = phi(x - h);
                const y2 = phi(x + h);
                return (y2 - y1) / (2 * h);
            };

            // Pfad berechnen
            const pathData = useMemo(() => {
                const path = [];
                let x = startX;
                let divergent = false;

                path.push({ x: x, y: 0 }); // Start
                
                for (let i = 0; i < iterations; i++) {
                    let nextY = phi(x);
                    
                    // Schutz vor Unendlich
                    if (!isFinite(nextY) || Math.abs(nextY) > 50) {
                        divergent = true;
                        break;
                    }

                    path.push({ x: x, y: nextY }); // Vertikal
                    path.push({ x: nextY, y: nextY }); // Horizontal
                    x = nextY;
                }
                return { path, lastX: x, divergent };
            }, [phi, startX]);

            // --- CLASSIFICATION LOGIC ---
            // Für den Baum müssen wir wissen: Wo sind wir gerade? 
            // Bei nicht-linearen Funktionen ändert sich die Ableitung.
            // Wir nehmen die Ableitung am letzten Punkt der Iteration (als Näherung für den Fixpunkt, falls konvergiert)
            // oder am Startpunkt, wenn es noch läuft.
            
            const currentEvalX = pathData.path.length > 2 
                ? pathData.path[Math.min(pathData.path.length - 1, currentStep * 2)].x 
                : startX;
                
            const effectiveSlope = calculateDerivative(currentEvalX);
            
            const absM = Math.abs(effectiveSlope);
            const isAttracting = absM < 1;
            const isRepelling = absM >= 1; // >= 1 auch für Chaos
            const isMonotone = effectiveSlope >= 0;
            const isOscillating = effectiveSlope < 0;

            // Helpers für SVG
            const toSvgX = (val) => ((val - rangeMin) / range) * size;
            const toSvgY = (val) => size - ((val - rangeMin) / range) * size;

            // Presets
            const loadPreset = (name) => {
                setMode('custom');
                setIsPlaying(false);
                setCurrentStep(0);
                if (name === 'cos') { setFormulaInput('cos(x)'); setStartX(0.1); }
                if (name === 'sqrt') { setFormulaInput('sqrt(x+1)'); setStartX(0.5); }
                if (name === 'logistic') { setFormulaInput('2.8 * x * (1-x)'); setStartX(0.1); } // Chaos Rand
                if (name === 'chaos') { setFormulaInput('3.9 * x * (1-x)'); setStartX(0.3); } // Echtes Chaos
                if (name === 'newton') { setFormulaInput('x - (x*x - 2)/(2*x)'); setStartX(4); } // Newton Wurzel 2
            };

            return (
                <div className="min-h-screen pb-20 max-w-6xl mx-auto px-4">
                    
                    {/* --- HEADER --- */}
                    <header className="py-6 border-b border-slate-200 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                <IconFunction /> Fixpunkt Labor <span className="bg-indigo-600 text-white text-xs px-2 py-0.5 rounded uppercase tracking-wider">Pro</span>
                            </h1>
                            <p className="text-slate-500 text-sm mt-1">Experimentiere mit linearen und nicht-linearen Funktionen.</p>
                        </div>
                        <div className="flex bg-white p-1 rounded-lg border border-slate-300 shadow-sm">
                            <button 
                                onClick={() => setMode('linear')}
                                className={`px-4 py-1.5 rounded-md text-sm font-bold transition-colors ${mode === 'linear' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}
                            >
                                Linear (Lernmodus)
                            </button>
                            <button 
                                onClick={() => setMode('custom')}
                                className={`px-4 py-1.5 rounded-md text-sm font-bold transition-colors ${mode === 'custom' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}
                            >
                                Profi (f(x) Eingabe)
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* --- LEFT: CONTROLS & TREE --- */}
                        <div className="lg:col-span-5 flex flex-col gap-6">
                            
                            {/* Input Panel */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-bold text-slate-700">Funktionseingabe</h2>
                                    <div className="flex gap-2">
                                         <button onClick={() => setIsPlaying(!isPlaying)} className="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg">{isPlaying ? <IconPause/> : <IconPlay/>}</button>
                                         <button onClick={() => {setCurrentStep(0); setIsPlaying(false);}} className="border p-2 rounded-lg hover:bg-slate-50"><IconRefresh/></button>
                                    </div>
                                </div>

                                {mode === 'linear' ? (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Steigung m</label>
                                            <div className="flex items-center gap-3">
                                                <input type="range" min="-2.5" max="2.5" step="0.1" value={slope} onChange={e => {setSlope(parseFloat(e.target.value)); setCurrentStep(0); setIsPlaying(false);}} className="flex-1" />
                                                <span className="font-mono bg-slate-100 px-2 py-1 rounded">{slope.toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <div className="p-3 bg-blue-50 text-blue-800 text-sm rounded border border-blue-100">
                                            <M>φ(x) = {slope} \cdot (x - 2) + 2</M>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Funktion φ(x)</label>
                                            <input 
                                                type="text" 
                                                value={formulaInput} 
                                                onChange={(e) => {setFormulaInput(e.target.value); setCurrentStep(0); setIsPlaying(false);}}
                                                className="w-full p-2 border border-slate-300 rounded font-mono text-indigo-700 focus:ring-2 focus:ring-indigo-200 outline-none"
                                                placeholder="z.B. cos(x)" 
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Beispiele (Presets)</label>
                                            <div className="flex flex-wrap gap-2">
                                                <button onClick={() => loadPreset('cos')} className="text-xs px-2 py-1 bg-slate-100 hover:bg-slate-200 rounded border">Cosinus</button>
                                                <button onClick={() => loadPreset('sqrt')} className="text-xs px-2 py-1 bg-slate-100 hover:bg-slate-200 rounded border">Wurzel</button>
                                                <button onClick={() => loadPreset('newton')} className="text-xs px-2 py-1 bg-slate-100 hover:bg-slate-200 rounded border">Newton √2</button>
                                                <button onClick={() => loadPreset('chaos')} className="text-xs px-2 py-1 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded border border-purple-200">Chaos</button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="mt-4 pt-4 border-t border-slate-100">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Startwert x₀: <span className="text-black font-mono">{startX.toFixed(2)}</span></label>
                                    <input type="range" min={rangeMin} max={rangeMax} step="0.05" value={startX} onChange={e => {setStartX(parseFloat(e.target.value)); setCurrentStep(0); setIsPlaying(false);}} className="w-full mt-1" />
                                </div>
                            </div>

                            {/* TREE VISUALIZATION */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative overflow-hidden">
                                <div className="text-center font-bold text-slate-400 text-xs uppercase mb-4 tracking-widest">Klassifikations-Baum</div>
                                
                                <div className="absolute top-2 right-2 text-[10px] text-slate-400 text-right bg-slate-50 p-1 rounded">
                                    Lokale Ableitung<br/>
                                    <span className="font-mono text-base font-bold text-slate-700">m ≈ {effectiveSlope.toFixed(2)}</span>
                                </div>

                                <div className="flex flex-col items-center gap-6">
                                    <div className="bg-slate-800 text-white px-4 py-1.5 rounded shadow text-sm font-bold">Fixpunkt x*</div>
                                    
                                    <div className="grid grid-cols-2 gap-8 w-full">
                                        <div className={`transition-all duration-500 border rounded-lg p-3 text-center ${isAttracting ? 'border-green-500 bg-green-50 shadow-md scale-105' : 'border-slate-100 opacity-40'}`}>
                                            <div className="font-bold text-green-800 text-sm">Anziehend</div>
                                            <div className="text-xs text-green-600 font-mono">|m| &lt; 1</div>
                                            
                                            <div className="flex gap-2 mt-3 justify-center">
                                                <div className={`text-[10px] border px-1 rounded ${isAttracting && isMonotone ? 'bg-green-200 border-green-400 font-bold' : 'border-transparent'}`}>Monoton</div>
                                                <div className={`text-[10px] border px-1 rounded ${isAttracting && isOscillating ? 'bg-green-200 border-green-400 font-bold' : 'border-transparent'}`}>Osz.</div>
                                            </div>
                                        </div>

                                        <div className={`transition-all duration-500 border rounded-lg p-3 text-center ${isRepelling ? 'border-red-500 bg-red-50 shadow-md scale-105' : 'border-slate-100 opacity-40'}`}>
                                            <div className="font-bold text-red-800 text-sm">Abstoßend</div>
                                            <div className="text-xs text-red-600 font-mono">|m| &gt; 1</div>

                                            <div className="flex gap-2 mt-3 justify-center">
                                                <div className={`text-[10px] border px-1 rounded ${isRepelling && isMonotone ? 'bg-red-200 border-red-400 font-bold' : 'border-transparent'}`}>Monoton</div>
                                                <div className={`text-[10px] border px-1 rounded ${isRepelling && isOscillating ? 'bg-red-200 border-red-400 font-bold' : 'border-transparent'}`}>Osz.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        {/* --- RIGHT: GRAPH --- */}
                        <div className="lg:col-span-7">
                            <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden h-full min-h-[500px] relative">
                                <div className="absolute top-4 left-4 z-10 bg-white/80 backdrop-blur px-3 py-1 rounded border border-slate-200 text-xs font-mono text-slate-500">
                                    Plot: x = [{rangeMin}, {rangeMax}]
                                </div>

                                <svg viewBox={`0 0 ${size} ${size}`} className="w-full h-full cursor-crosshair">
                                    <defs>
                                        <pattern id="smallGrid" width="20" height="20" patternUnits="userSpaceOnUse">
                                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f1f5f9" strokeWidth="1"/>
                                        </pattern>
                                    </defs>
                                    <rect width="100%" height="100%" fill="url(#smallGrid)" />
                                    
                                    {/* Achsen (dynamisch je nach range) */}
                                    <line x1="0" y1={toSvgY(0)} x2={size} y2={toSvgY(0)} stroke="#94a3b8" strokeWidth="2" />
                                    <line x1={toSvgX(0)} y1={size} x2={toSvgX(0)} y2={0} stroke="#94a3b8" strokeWidth="2" />

                                    {/* Winkelhalbierende y=x */}
                                    <line x1="0" y1={size} x2={size} y2={0} stroke="#cbd5e1" strokeWidth="2" strokeDasharray="5,5" />
                                    <text x={size-40} y={20} className="fill-slate-400 text-xs font-serif italic">y = x</text>

                                    {/* Funktionsplot φ(x) */}
                                    {/* Wir zeichnen viele kleine Liniensegmente für die Kurve */}
                                    <path 
                                        d={(() => {
                                            let d = "";
                                            const steps = 200;
                                            for(let i=0; i<=steps; i++) {
                                                const xVal = rangeMin + (i/steps)*range;
                                                const yVal = phi(xVal);
                                                // Clipping für Anzeige
                                                if (yVal > rangeMax + 5 || yVal < rangeMin - 5) continue;
                                                
                                                const sx = toSvgX(xVal);
                                                const sy = toSvgY(yVal);
                                                d += (i===0 ? "M" : "L") + `${sx},${sy} `;
                                            }
                                            return d;
                                        })()}
                                        fill="none"
                                        stroke={isAttracting ? '#10b981' : '#ef4444'}
                                        strokeWidth="3"
                                        strokeLinecap="round"
                                        strokeLinejoin="round"
                                        className="transition-colors duration-500"
                                    />

                                    {/* Cobweb Path */}
                                    {pathData.path.slice(0, currentStep * 2 + 2).map((pt, i, arr) => {
                                        if (i === 0) return null;
                                        const prev = arr[i-1];
                                        return (
                                            <line 
                                                key={i}
                                                x1={toSvgX(prev.x)} y1={toSvgY(prev.y)}
                                                x2={toSvgX(pt.x)} y2={toSvgY(pt.y)}
                                                stroke="#4f46e5" strokeWidth="1.5" opacity="0.7"
                                            />
                                        )
                                    })}

                                    {/* Current Point */}
                                    {currentStep > 0 && pathData.path[Math.min(pathData.path.length-1, currentStep*2)] && (
                                        <circle 
                                            cx={toSvgX(pathData.path[Math.min(pathData.path.length-1, currentStep*2)].x)}
                                            cy={toSvgY(pathData.path[Math.min(pathData.path.length-1, currentStep*2)].y)}
                                            r="4" fill="#4f46e5" className="animate-pulse"
                                        />
                                    )}

                                </svg>
                            </div>
                            
                            {/* Erklärungstext unten */}
                            <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-900">
                                <strong className="block mb-1 font-bold">Interpretation:</strong>
                                {mode === 'linear' 
                                  ? "Bei linearen Funktionen ist die Steigung überall gleich. Der Fixpunkt ist stabil, wenn die Steigung im Betrag < 1 ist." 
                                  : <span>Bei nicht-linearen Funktionen (wie <span className="font-mono">{formulaInput}</span>) entscheidet die Steigung <em>lokal am Schnittpunkt</em>. Ist sie dort steil (>1 oder &lt;-1), wird der Punkt abgestoßen – selbst wenn die Kurve woanders flach ist.</span>
                                }
                            </div>
                        </div>

                    </div>
                    
                    <footer className="text-center text-slate-400 text-xs py-8 mt-8 border-t border-slate-200">
                        Pro-Version für Mathematik & Informatik Didaktik
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        document.getElementById('loading').style.display = 'none';
    </script>
</body>
</html>

 
